#include <stdint.h>
#include <math.h>

#include "top_defines.h"

#define LED_CONFIG                  *((volatile uint32_t *)(0x00080000 | LED_CONFIG_ADDR  ))

#define REG_WR(reg_name, wr_data)   (*((volatile uint32_t *)(0x00080000 | reg_name##_ADDR)) = (wr_data))
#define REG_RD(reg_name)            (*((volatile uint32_t *)(0x00080000 | reg_name##_ADDR)))

#define REG_WR_FP32(reg_name, wr_data)   (*((volatile uint32_t *)(0x00080000 | reg_name##_ADDR)) = float_to_fpxx(wr_data))
//#define REG_RD_FP32(reg_name)            (*((volatile uint32_t *)(0x00080000 | reg_name##_ADDR))

static inline uint32_t rdcycle(void) {
    uint32_t cycle;
    asm volatile ("rdcycle %0" : "=r"(cycle));
    return cycle;
}

void wait(int cycles)
{
#if 1
    volatile int cnt = 0;

    for(int i=0;i<cycles;++i){
        ++cnt;
    }
#else
    int start;

    start = rdcycle();
    while ((rdcycle() - start) <= cycles);
#endif
}


#define WAIT_CYCLES 1000000

// ruby -e "256.times { |i| puts \"    sin(#{i}/360.0*256),\n\" }"
#pragma GCC diagnostic push
#pragma GCC diagnostic ignored "-Wpedantic"
const float sin_table[256] = {
    sin(0/360.0*256),
    sin(1/360.0*256),
    sin(2/360.0*256),
    sin(3/360.0*256),
    sin(4/360.0*256),
    sin(5/360.0*256),
    sin(6/360.0*256),
    sin(7/360.0*256),
    sin(8/360.0*256),
    sin(9/360.0*256),
    sin(10/360.0*256),
    sin(11/360.0*256),
    sin(12/360.0*256),
    sin(13/360.0*256),
    sin(14/360.0*256),
    sin(15/360.0*256),
    sin(16/360.0*256),
    sin(17/360.0*256),
    sin(18/360.0*256),
    sin(19/360.0*256),
    sin(20/360.0*256),
    sin(21/360.0*256),
    sin(22/360.0*256),
    sin(23/360.0*256),
    sin(24/360.0*256),
    sin(25/360.0*256),
    sin(26/360.0*256),
    sin(27/360.0*256),
    sin(28/360.0*256),
    sin(29/360.0*256),
    sin(30/360.0*256),
    sin(31/360.0*256),
    sin(32/360.0*256),
    sin(33/360.0*256),
    sin(34/360.0*256),
    sin(35/360.0*256),
    sin(36/360.0*256),
    sin(37/360.0*256),
    sin(38/360.0*256),
    sin(39/360.0*256),
    sin(40/360.0*256),
    sin(41/360.0*256),
    sin(42/360.0*256),
    sin(43/360.0*256),
    sin(44/360.0*256),
    sin(45/360.0*256),
    sin(46/360.0*256),
    sin(47/360.0*256),
    sin(48/360.0*256),
    sin(49/360.0*256),
    sin(50/360.0*256),
    sin(51/360.0*256),
    sin(52/360.0*256),
    sin(53/360.0*256),
    sin(54/360.0*256),
    sin(55/360.0*256),
    sin(56/360.0*256),
    sin(57/360.0*256),
    sin(58/360.0*256),
    sin(59/360.0*256),
    sin(60/360.0*256),
    sin(61/360.0*256),
    sin(62/360.0*256),
    sin(63/360.0*256),
    sin(64/360.0*256),
    sin(65/360.0*256),
    sin(66/360.0*256),
    sin(67/360.0*256),
    sin(68/360.0*256),
    sin(69/360.0*256),
    sin(70/360.0*256),
    sin(71/360.0*256),
    sin(72/360.0*256),
    sin(73/360.0*256),
    sin(74/360.0*256),
    sin(75/360.0*256),
    sin(76/360.0*256),
    sin(77/360.0*256),
    sin(78/360.0*256),
    sin(79/360.0*256),
    sin(80/360.0*256),
    sin(81/360.0*256),
    sin(82/360.0*256),
    sin(83/360.0*256),
    sin(84/360.0*256),
    sin(85/360.0*256),
    sin(86/360.0*256),
    sin(87/360.0*256),
    sin(88/360.0*256),
    sin(89/360.0*256),
    sin(90/360.0*256),
    sin(91/360.0*256),
    sin(92/360.0*256),
    sin(93/360.0*256),
    sin(94/360.0*256),
    sin(95/360.0*256),
    sin(96/360.0*256),
    sin(97/360.0*256),
    sin(98/360.0*256),
    sin(99/360.0*256),
    sin(100/360.0*256),
    sin(101/360.0*256),
    sin(102/360.0*256),
    sin(103/360.0*256),
    sin(104/360.0*256),
    sin(105/360.0*256),
    sin(106/360.0*256),
    sin(107/360.0*256),
    sin(108/360.0*256),
    sin(109/360.0*256),
    sin(110/360.0*256),
    sin(111/360.0*256),
    sin(112/360.0*256),
    sin(113/360.0*256),
    sin(114/360.0*256),
    sin(115/360.0*256),
    sin(116/360.0*256),
    sin(117/360.0*256),
    sin(118/360.0*256),
    sin(119/360.0*256),
    sin(120/360.0*256),
    sin(121/360.0*256),
    sin(122/360.0*256),
    sin(123/360.0*256),
    sin(124/360.0*256),
    sin(125/360.0*256),
    sin(126/360.0*256),
    sin(127/360.0*256),
    sin(128/360.0*256),
    sin(129/360.0*256),
    sin(130/360.0*256),
    sin(131/360.0*256),
    sin(132/360.0*256),
    sin(133/360.0*256),
    sin(134/360.0*256),
    sin(135/360.0*256),
    sin(136/360.0*256),
    sin(137/360.0*256),
    sin(138/360.0*256),
    sin(139/360.0*256),
    sin(140/360.0*256),
    sin(141/360.0*256),
    sin(142/360.0*256),
    sin(143/360.0*256),
    sin(144/360.0*256),
    sin(145/360.0*256),
    sin(146/360.0*256),
    sin(147/360.0*256),
    sin(148/360.0*256),
    sin(149/360.0*256),
    sin(150/360.0*256),
    sin(151/360.0*256),
    sin(152/360.0*256),
    sin(153/360.0*256),
    sin(154/360.0*256),
    sin(155/360.0*256),
    sin(156/360.0*256),
    sin(157/360.0*256),
    sin(158/360.0*256),
    sin(159/360.0*256),
    sin(160/360.0*256),
    sin(161/360.0*256),
    sin(162/360.0*256),
    sin(163/360.0*256),
    sin(164/360.0*256),
    sin(165/360.0*256),
    sin(166/360.0*256),
    sin(167/360.0*256),
    sin(168/360.0*256),
    sin(169/360.0*256),
    sin(170/360.0*256),
    sin(171/360.0*256),
    sin(172/360.0*256),
    sin(173/360.0*256),
    sin(174/360.0*256),
    sin(175/360.0*256),
    sin(176/360.0*256),
    sin(177/360.0*256),
    sin(178/360.0*256),
    sin(179/360.0*256),
    sin(180/360.0*256),
    sin(181/360.0*256),
    sin(182/360.0*256),
    sin(183/360.0*256),
    sin(184/360.0*256),
    sin(185/360.0*256),
    sin(186/360.0*256),
    sin(187/360.0*256),
    sin(188/360.0*256),
    sin(189/360.0*256),
    sin(190/360.0*256),
    sin(191/360.0*256),
    sin(192/360.0*256),
    sin(193/360.0*256),
    sin(194/360.0*256),
    sin(195/360.0*256),
    sin(196/360.0*256),
    sin(197/360.0*256),
    sin(198/360.0*256),
    sin(199/360.0*256),
    sin(200/360.0*256),
    sin(201/360.0*256),
    sin(202/360.0*256),
    sin(203/360.0*256),
    sin(204/360.0*256),
    sin(205/360.0*256),
    sin(206/360.0*256),
    sin(207/360.0*256),
    sin(208/360.0*256),
    sin(209/360.0*256),
    sin(210/360.0*256),
    sin(211/360.0*256),
    sin(212/360.0*256),
    sin(213/360.0*256),
    sin(214/360.0*256),
    sin(215/360.0*256),
    sin(216/360.0*256),
    sin(217/360.0*256),
    sin(218/360.0*256),
    sin(219/360.0*256),
    sin(220/360.0*256),
    sin(221/360.0*256),
    sin(222/360.0*256),
    sin(223/360.0*256),
    sin(224/360.0*256),
    sin(225/360.0*256),
    sin(226/360.0*256),
    sin(227/360.0*256),
    sin(228/360.0*256),
    sin(229/360.0*256),
    sin(230/360.0*256),
    sin(231/360.0*256),
    sin(232/360.0*256),
    sin(233/360.0*256),
    sin(234/360.0*256),
    sin(235/360.0*256),
    sin(236/360.0*256),
    sin(237/360.0*256),
    sin(238/360.0*256),
    sin(239/360.0*256),
    sin(240/360.0*256),
    sin(241/360.0*256),
    sin(242/360.0*256),
    sin(243/360.0*256),
    sin(244/360.0*256),
    sin(245/360.0*256),
    sin(246/360.0*256),
    sin(247/360.0*256),
    sin(248/360.0*256),
    sin(249/360.0*256),
    sin(250/360.0*256),
    sin(251/360.0*256),
    sin(252/360.0*256),
    sin(253/360.0*256),
    sin(254/360.0*256),
    sin(255/360.0*256)
};
#pragma GCC diagnostic pop

inline uint32_t float_to_fpxx(float f)
{
    union {
        float       f;
        uint32_t    i;
    } fi;

    fi.f = f;

    uint32_t sign = fi.i>>31;
    uint32_t exp  = (fi.i>>23) & 0xff;
    uint32_t mant = fi.i & ((1<<23)-1);

    exp  = (exp == 0) ? 0 : exp-127+((1<<(6-1))-1);
    mant = mant >> (23-13);

    uint32_t result = (sign<<(6+13)) | (exp<<13) | mant;
    return result;
}

int main() {

    REG_WR_FP32(CAMERA_POS_X, 0.0);
    REG_WR_FP32(CAMERA_POS_Y, 10.0);
    REG_WR_FP32(CAMERA_POS_Z, -10.0);

    REG_WR_FP32(ROT_X_SIN, 0.33688985339222005);
    REG_WR_FP32(ROT_X_COS, 0.94154406518302081);

    REG_WR_FP32(ROT_Y_SIN, 0.17096188876030122);
    REG_WR_FP32(ROT_Y_COS, 0.98527764238894122);

    REG_WR(LED_CONFIG, 0x00);

    int cam_cntr = 0;
    int frame_cntr = 0;


    while(1){
        // Wait until end of frame...
        while(!REG_RD(EOF));
        REG_WR(EOF, 1);

        // Blink every 60 frames.
        REG_WR(LED_CONFIG, (frame_cntr & 64)==0 && 0x7);

        //float z_pos;
        //z_pos = cam_cntr/64.0 * 5 -10;
        //REG_WR_FP32(CAMERA_POS_Z, z_pos);

        ++cam_cntr;
        if (cam_cntr == 60)
            cam_cntr = 0;

        ++frame_cntr;
    }
}
